const { 
    Client, 
    GatewayIntentBits, 
    Partials, 
    EmbedBuilder, 
    ActionRowBuilder, 
    ButtonBuilder, 
    ButtonStyle, 
    SlashCommandBuilder, 
    PermissionFlagsBits, 
    REST, 
    Routes,
    ChannelType // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
} = require('discord.js');

const { joinVoiceChannel } = require('@discordjs/voice'); // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á

// --- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô ---
const TOKEN = process.env.TOKEN || '‡πÉ‡∏™‡πà_TOKEN_‡∏ö‡∏≠‡∏ó_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ'; 
const CLIENT_ID = process.env.CLIENT_ID || '‡πÉ‡∏™‡πà_CLIENT_ID_‡∏ö‡∏≠‡∏ó_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ'; 
const OWNER_ID = process.env.OWNER_ID || '‡πÉ‡∏™‡πà_‡πÑ‡∏≠‡∏î‡∏µ_‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ'; 

const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMembers, 
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.GuildVoiceStates // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç! ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    ],
    partials: [Partials.Channel, Partials.Message, Partials.Reaction]
});

// --- üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Slash Command (‡∏£‡∏ß‡∏° 2 ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á) ---
const commands = [
    // 1. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏¢‡∏®
    new SlashCommandBuilder()
        .setName('setup-verify')
        .setDescription('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ Panel ‡∏£‡∏±‡∏ö‡∏¢‡∏®‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)')
        .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
        .addRoleOption(option => 
            option.setName('role')
                .setDescription('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏®‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏à‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å')
                .setRequired(true)),
    
    // 2. ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏≠‡∏ó‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÉ‡∏´‡∏°‡πà! ‚ú®)
    new SlashCommandBuilder()
        .setName('join-voice') // ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏õ‡∏≤‡∏¢‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏´‡πâ
        .setDescription('‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏¥‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á 24/7 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)')
        .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
        .addChannelOption(option => 
            option.setName('channel')
                .setDescription('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏õ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤')
                .addChannelTypes(ChannelType.GuildVoice) // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                .setRequired(true))
]
.map(command => command.toJSON());

const rest = new REST({ version: '10' }).setToken(TOKEN);

// --- ü§ñ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó ---
client.once('ready', async () => {
    console.log(`‚úÖ ‡∏ô‡πâ‡∏≠‡∏á‡∏õ‡∏≤‡∏¢‡∏°‡∏≤‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞! ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠: ${client.user.tag}`);
    
    try {
        console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á Slash Command...');
        await rest.put(
            Routes.applicationCommands(CLIENT_ID),
            { body: commands },
        );
        console.log('‚ú® ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≤!');
    } catch (error) {
        console.error(error);
    }
});

// --- üëÇ ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á ---
client.on('interactionCreate', async interaction => {
    
    // üîí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏° (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Slash Command)
    if (interaction.isChatInputCommand()) {
        if (interaction.user.id !== OWNER_ID) {
            return interaction.reply({ 
                content: '‚ùå **‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ñ‡πà‡∏∞!** ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ **‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô** ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô! üò§', 
                ephemeral: true 
            });
        }
    }

    // 1Ô∏è‚É£ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /setup-verify (‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏¢‡∏®)
    if (interaction.isChatInputCommand() && interaction.commandName === 'setup-verify') {
        const role = interaction.options.getRole('role');

        const embed = new EmbedBuilder()
            .setColor('#FF69B4')
            .setTitle('‚ú® ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‚ú®')
            .setDescription(`‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà **${interaction.guild.name}** ‡∏ô‡∏∞‡∏Ñ‡∏∞! üéâ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **"‚úÖ ‡∏£‡∏±‡∏ö‡∏¢‡∏®‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏¥‡∏™"** ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏® <@&${role.id}> ‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ñ‡πà‡∏∞\n\n*‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏∞~ üíñ*`)
            .setImage('https://media.discordapp.net/attachments/1079089989930745917/1105497258381594684/standard.gif')
            .setFooter({ text: '‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢ ‡∏ô‡πâ‡∏≠‡∏á‡∏õ‡∏≤‡∏¢ (Swift Hub Core) ‚öôÔ∏è', iconURL: client.user.displayAvatarURL() })
            .setTimestamp();

        const row = new ActionRowBuilder()
            .addComponents(
                new ButtonBuilder()
                    .setCustomId(`verify_button_${role.id}`)
                    .setLabel('‡∏£‡∏±‡∏ö‡∏¢‡∏®‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡∏¥‡∏™')
                    .setEmoji('‚úÖ')
                    .setStyle(ButtonStyle.Success)
            );

        await interaction.reply({ content: '‚úÖ ‡∏õ‡∏≤‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤ Panel ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞!', ephemeral: true });
        await interaction.channel.send({ embeds: [embed], components: [row] });
    }

    // 2Ô∏è‚É£ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /join-voice (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á)
    if (interaction.isChatInputCommand() && interaction.commandName === 'join-voice') {
        const channel = interaction.options.getChannel('channel');

        try {
            // ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            joinVoiceChannel({
                channelId: channel.id,
                guildId: interaction.guild.id,
                adapterCreator: interaction.guild.voiceAdapterCreator,
                selfDeaf: true, // ‡∏õ‡∏¥‡∏î‡∏´‡∏π‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ô‡πá‡∏ï)
                selfMute: false // ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡∏Ñ‡πå (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏û‡∏π‡∏î)
            });

            await interaction.reply({ 
                content: `‚úÖ **‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö‡∏Ñ‡πà‡∏∞‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô!** ‡∏õ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏™‡∏¥‡∏á‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á <#${channel.id}> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üîä\n*‡∏õ‡∏≤‡∏¢‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ù‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏¢‡∏≤‡∏ß‡πÜ ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡πÇ‡∏•‡∏Å‡∏à‡∏∞‡πÅ‡∏ï‡∏Å‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏≤~*`, 
                ephemeral: true 
            });

        } catch (error) {
            console.error(error);
            await interaction.reply({ content: '‚ùå ‡∏õ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤... ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏≤‡∏¢‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡πâ‡∏≤~ ü•∫', ephemeral: true });
        }
    }

    // 3Ô∏è‚É£ ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏±‡∏ö‡∏¢‡∏® (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    if (interaction.isButton()) {
        if (interaction.customId.startsWith('verify_button_')) {
            const roleId = interaction.customId.split('_')[2];
            const role = interaction.guild.roles.cache.get(roleId);
            const member = interaction.member;

            if (!role) return interaction.reply({ content: '‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏¢‡∏®‡∏ô‡∏µ‡πâ‡∏Ñ‡πà‡∏∞', ephemeral: true });
            if (member.roles.cache.has(roleId)) return interaction.reply({ content: 'üåü ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≤!', ephemeral: true });

            try {
                await member.roles.add(role);
                await interaction.reply({ content: `‚úÖ **‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!** ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏® **${role.name}** ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üíñ`, ephemeral: true });
            } catch (error) {
                await interaction.reply({ content: '‚ùå ‡∏õ‡∏≤‡∏¢‡∏¢‡∏®‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏¢‡∏®‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏à‡∏Å‡∏Ñ‡πà‡∏∞‡∏ã‡∏µ‡∏°‡πà‡∏≠‡∏ô ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏õ‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏´‡∏ô‡πà‡∏≠‡∏¢~ ü•∫', ephemeral: true });
            }
        }
    }
});

client.login(TOKEN);
